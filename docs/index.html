<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像推論</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite/dist/tf-tflite.min.js"></script>
  </head>

  <body>
    <p>更新１０</p>
    <p>画像を選択してください:</p>
    <input type="file" id="file-input">
    <img id="image-preview" style="max-width: 300px; max-height: 300px; border: 1px solid #ccc; display: none;">
    <button id="button" onclick="run()">推論実行</button>
    <div id="result"></div>

    <script>
      const fileInput = document.getElementById('file-input');
      const previewImage = document.getElementById('image-preview');
  
      fileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';
          };
          reader.readAsDataURL(file);
        };
      })

      async function run() {
        const model = await tflite.loadTFLiteModel('save_data/save_2/model.tflite'); // モデルのロード
        const img = document.getElementById('image-preview');
        const tensor = tf.browser.fromPixels(img)
                          .resizeNearestNeighbor([224, 224])  // 画像を 224x224 にリサイズ
                          .div(tf.scalar(255.0))  // 正規化
                          .expandDims();  // バッチ次元を追加
        const output = model.predict(tensor);
        const outputData = output.dataSync();
        const predictedClass = outputData.indexOf(Math.max(...outputData)); // 最大値のインデックス取得
        const confidence = Math.max(...outputData);
        const confidencePercentage = Math.round(confidence * 100 * 100) / 100; // 2桁の精度で切り捨て

        const labels = ["ある", "ない"]; // ラベルのリスト
        const result = labels[predictedClass];

        document.getElementById('result').innerHTML = `
          <p>推論結果: ${result}</p>
          <p>信頼度: ${confidencePercentage}%</p>
        `;
      }
    </script>
  </body>
</html>
