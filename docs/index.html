<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tensorflow.js_test</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite/dist/tf-tflite.min.js"></script>
  </head>

  <body>
    <p>更新７</p>
    <input type="file" id="file-input">
    <img id="image-preview" style="max-width: 300px; max-height: 300px; border: 1px solid #ccc;">
    <input config="Class" type="button" id="button" onclick="run()">
    <p id="pred">結果がここに表示されます</p>

    <script>
      const fileInput = document.getElementById('file-input');
      const previewImage = document.getElementById('image-preview');
  
      fileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';
          };
          reader.readAsDataURL(file);
        };
      })

      async function run() {
        const model = await tflite.loadTFLiteModel('model.tflite');
        const img = document.getElementById('image-preview');
        const tensor = tf.browser.fromPixels(img)
                          .resizeNearestNeighbor([224, 224])  // 画像を 224x224 にリサイズ
                          .div(tf.scalar(255.0))  // 正規化
                          .expandDims();  // バッチ次元を追加
        const y = model.predict(tensor);
        const predictedClass = y.reshape([-1]).argMax().arraySync();
        const confidence = y.max().arraySync()[0];
        const confidencePercentage = Math.round(confidence * 100 * 100) / 100; // 2桁の精度で切り捨て

        document.getElementById('pred').innerHTML = `
          <p>Predicted class(NO.1): ${predictedClass}</p>
          <p>Confidence(NO.1): ${confidencePercentage} %</p>
        `;
      }
    </script>
  </body>
</html>
